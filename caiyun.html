<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基于彩云天气API更新的天气信息</title>
    <style>
        body {
            line-height: 1;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f5ff;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .weather-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        .weather-card h2 {
            color: #3498db;
            margin-top: 0;
        }
        .weather-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 5px;
        }
        .weather-info p {
            margin: 10px 0;
        }
        .precipitation-info {
            list-style: none;
            padding: 0;
        }
        .precipitation-info li {
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        .precipitation-info li:last-child {
            border-bottom: none;
        }
		.single-item li {
		border-bottom: 1px solid #ecf0f1 !important; /* 强制显示下划线 */
		}
        #temperatureChartContainer {
            height: 400px;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .weather-info {
                grid-template-columns: 1fr;
            }
            #temperatureChartContainer {
                height: 300px;
            }
        }
    </style>
</head>
<body>

    <div id="weatherInfo"><h2><strong><center>正在加载天气数据...</strong></center></h2></div>
    <div class="weather-card" id="temperatureChartContainer">
        <h2>未来小时气温和湿度预报</h2>
        <canvas id="temperatureChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.0/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
        function fetchWeather() {
            const script = document.createElement('script');
            script.src = 'https://api.caiyunapp.com/v2.6/密钥/经纬度/weather?unit=metric:v2&callback=displayWeather';
            document.body.appendChild(script);
        }

        function displayWeather(data) {
            const weatherInfo = document.getElementById('weatherInfo');
            let html = '';

            if (data && data.result && data.result.realtime) {
                const serverTime = data.server_time;
                const realtime = data.result.realtime;

                html += '<div class="weather-card">';
                html += '<h2>实时天气</h2>';
                html += '<br>';
                const date = new Date(serverTime * 1000);
                html += `<p><center>获取时间: ${date.toLocaleString()}</center></p>`;
                html += `<ul class="precipitation-info single-item"><li><center><strong style="color:#f0768b; font-size: 18px;">${data.result.forecast_keypoint}</strong></center></li></ul>`;
                html += '<div class="weather-info">';
                html += `<p><strong>温度:</strong> ${realtime.temperature.toFixed(2)}°C / <strong>体感:</strong>${realtime.apparent_temperature.toFixed(2)}°C</p>`;
                html += `<p><strong>湿度:</strong> ${(realtime.humidity * 100).toFixed(0)}% / <strong>舒适度:</strong> ${realtime.life_index.comfort.desc}</p>`;
                html += `<p><strong>天气状况:</strong> ${getSkyconDescription(realtime.skycon)} / ${getWindDirection(realtime.wind.direction)}风</p>`;
                const windSpeed = realtime.wind.speed.toFixed(1);
                const windLevelAndName = getWindLevelAndName(windSpeed);
                html += `<p><strong>风速:</strong> ${windSpeed} km/h【${windLevelAndName}】</p>`;
                html += `<p><strong>能见度:</strong> ${realtime.visibility.toFixed(1)}km</p>`;
                html += `<p><strong>紫外线指数:</strong> ${realtime.life_index.ultraviolet.index}【${realtime.life_index.ultraviolet.desc}】</p>`;
                html += `<p><strong>总云量:</strong> ${(realtime.cloudrate * 100).toFixed(0)}%</p>`;
                html += `<p><strong>气压:</strong> ${(realtime.pressure / 100).toFixed(2)} hPa</p>`;
                html += `<p><strong>AQI:</strong> ${realtime.air_quality.aqi.chn}【${realtime.air_quality.description.chn}】</p>`;
                html += `<p><strong>PM2.5:</strong> ${realtime.air_quality.pm25} μg/m³</p>`;
                html += `<p><strong>PM10:</strong> ${realtime.air_quality.pm10} μg/m³</p>`;
                html += `<p><strong>臭氧浓度:</strong> ${realtime.air_quality.o3} μg/m³</p>`;
                html += `<p><strong>一氧化碳浓度:</strong> ${realtime.air_quality.co} mg/m³</p>`;
                html += `<p><strong>二氧化氮浓度:</strong> ${realtime.air_quality.no2} μg/m³</p>`;
                html += `<p><strong>二氧化硫浓度:</strong> ${realtime.air_quality.so2} μg/m³</p>`;
                html += `<p><strong>最近降水带距离:</strong> ${realtime.precipitation.nearest.distance.toFixed(0)} km</p>`;
                html += `<p><strong>最近降水强度:</strong> ${realtime.precipitation.nearest.intensity.toFixed(1)} mm/h</p>`;
                html += `<p><strong>本地降水强度:</strong> ${realtime.precipitation.local.intensity.toFixed(1)} mm/h</p>`;
                html += '</div></div>';

                // 小时级降水预报
				html += `<div class="weather-card"><h2>小时级降水预报</h2>${renderPrecipitationForecast(data.result.hourly)}</div>`;

                function formatDateTime(datetime) {
                const date = new Date(datetime);
                return `${date.getMonth() + 1}月${date.getDate()}日${date.getHours()}时`;
                }

                function renderPrecipitationForecast(hourly) {
                if (!hourly || !hourly.precipitation || !Array.isArray(hourly.precipitation)) {
                return '<p><center><strong style="color:#DC143C;">暂无数据</strong></center></p>';
                }

                const precipitationItems = hourly.precipitation
				.filter(precip => precip.value >= 0.05)
                .map(precip => `<li><strong>${formatDateTime(precip.datetime)}:</strong> 降水量 ${precip.value.toFixed(1)} mm/h，降水概率 ${precip.probability}%</li>`);

                if (precipitationItems.length === 0) {
                return '<p><center><strong style="color:#228B22;">未来48小时内无降水</strong></center></p>';
                }

                return `<ul class="precipitation-info">${precipitationItems.join('')}</ul>`;
                }


                // 未来3天预报
                html += '<div class="weather-card">';
                html += '<h2>未来3天预报</h2>';
                const daily = data.result.daily;

                if (daily && daily.temperature && daily.skycon && daily.air_quality && daily.wind && daily.astro) {
				html += '<ul class="precipitation-info">';
                daily.temperature.slice(0, 3).forEach((temp, index) => {
                if (daily.skycon[index] && daily.air_quality.aqi[index] && daily.wind[index] && daily.astro[index]) {
                const date = new Date(temp.date);
                const formattedDate = `${date.getMonth() + 1}月${date.getDate()}日`;

                const skycon = getSkyconDescription(daily.skycon[index].value);
                const aqi = daily.air_quality.aqi[index].avg ? daily.air_quality.aqi[index].avg.chn : '无数据';
                const windSpeed = daily.wind[index].avg ? daily.wind[index].avg.speed.toFixed(1) : '无数据';
                const windDirection = daily.wind[index].avg ? getWindDirection(daily.wind[index].avg.direction) : '无数据';
                const sunrise = daily.astro[index].sunrise.time;
                const sunset = daily.astro[index].sunset.time;

                html += `<li><strong>${formattedDate}</strong>: 【<strong style="color:#1E90FF;">${temp.min.toFixed(1)}°C</strong> ~ <strong style="color:#FF4500;">${temp.max.toFixed(1)}°C</strong>】/ ${skycon} / AQI: ${aqi} / 风速: ${windSpeed} km/h 【${windLevelAndName}】/ ${windDirection}风 / 日出: ${sunrise}, 日落: ${sunset}</li>`;
                }
                });
				html += '</ul>';
                } else {
                html += '<p>未来天气数据获取失败</p>';
                }
                html += '</div>';


                // 生成气温和湿度折线图
                const temperatureData = data.result.hourly.temperature;
                const humidityData = data.result.hourly.humidity;

                const labels = temperatureData.map(temp => {
                    const date = new Date(temp.datetime);
                    return `${date.getDate()}日${date.getHours()}时`;
                });

                const temperatureValues = temperatureData.map(temp => temp.value);
                const humidityValues = humidityData.map(hum => hum.value * 100);

                const ctx = document.getElementById('temperatureChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '气温 (°C)',
                                data: temperatureValues,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderWidth: 2,
                                yAxisID: 'y1',
                                tension: 0.1
                            },
                            {
                                label: '湿度 (%)',
                                data: humidityValues,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderWidth: 2,
                                yAxisID: 'y2',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '气温 (°C)'
                                }
                            },
                            y2: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '湿度 (%)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            } else {
                html = '<p>获取天气数据失败，请稍后再试。</p>';
            }

            weatherInfo.innerHTML = html;
        }

        function getSkyconDescription(skycon) {
            const skyconMap = {
                'CLEAR_DAY': '晴天',
                'CLEAR_NIGHT': '晴夜',
                'PARTLY_CLOUDY_DAY': '多云',
                'PARTLY_CLOUDY_NIGHT': '多云',
                'CLOUDY': '阴',
                'LIGHT_RAIN': '小雨',
                'MODERATE_RAIN': '中雨',
                'HEAVY_RAIN': '大雨',
                'STORM_RAIN': '暴雨',
                'FOG': '雾',
                'LIGHT_SNOW': '小雪',
                'MODERATE_SNOW': '中雪',
                'HEAVY_SNOW': '大雪',
                'STORM_SNOW': '暴雪',
                'DUST': '浮尘',
                'SAND': '沙尘',
                'WIND': '大风',
                'LIGHT_HAZE': '轻度雾霾',
                'MODERATE_HAZE': '中度雾霾',
                'HEAVY_HAZE': '重度雾霾'
            };
            return skyconMap[skycon] || skycon;
        }

        function getWindDirection(degree) {
            const directions = ['北', '东北', '东', '东南', '南', '西南', '西', '西北'];
            return directions[Math.round(degree / 45) % 8];
        }
		
		function getWindLevelAndName(speedKmH) {
		const windLevels = [
        { level: 0, name: '无风', min: 0, max: 0.9 },
        { level: 1, name: '软风', min: 1, max: 5.9 },
        { level: 2, name: '轻风', min: 6, max: 11.9 },
        { level: 3, name: '微风', min: 12, max: 19.9 },
        { level: 4, name: '和风', min: 20, max: 28.9 },
        { level: 5, name: '清风', min: 29, max: 38.9 },
        { level: 6, name: '强风', min: 39, max: 49.9 },
        { level: 7, name: '劲风', min: 50, max: 61.9 },
        { level: 8, name: '大风', min: 62, max: 74.9 },
        { level: 9, name: '烈风', min: 75, max: 88.9 },
        { level: 10, name: '狂风', min: 89, max: 102.9 },
        { level: 11, name: '暴风', min: 103, max: 117.9 },
        { level: 12, name: '台风', min: 118, max: Infinity }
		];

		for (let i = 0; i < windLevels.length; i++) {
        if (speedKmH >= windLevels[i].min && speedKmH <= windLevels[i].max) {
            return `${windLevels[i].level}级/${windLevels[i].name}`;
        }
		}
		return '未知风力';
		}

        // 页面加载完成后获取天气信息
        window.onload = fetchWeather;
		
		// 自动刷新和倒计时脚本
		const refreshInterval = 5 * 60 * 1000; // 5分钟
		let timeLeft = refreshInterval / 1000;

		function updateCountdown() {
		const minutes = Math.floor(timeLeft / 60);
		const seconds = timeLeft % 60;
		document.getElementById('countdown').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
		if (timeLeft > 0) {
        timeLeft--;
        setTimeout(updateCountdown, 1000);
		} else {
        location.reload();
		}
		}

		// 创建倒计时显示元素
		const countdownDiv = document.createElement('div');
		countdownDiv.id = 'countdown';
		countdownDiv.style.position = 'fixed';
		countdownDiv.style.top = '10px';
		countdownDiv.style.right = '10px';
		countdownDiv.style.background = 'rgba(0,0,0,0.5)';
		countdownDiv.style.color = 'white';
		countdownDiv.style.padding = '5px 10px';
		countdownDiv.style.borderRadius = '5px';
		document.body.appendChild(countdownDiv);

		// 开始倒计时
		updateCountdown();
		
    </script>
	<div class="weather-card">彩云API申请：https://docs.caiyunapp.com/weather-api/index.html<br><br>本项目更新：https://github.com/Naivev/caiyunhtml</div>
</body>
</html>
