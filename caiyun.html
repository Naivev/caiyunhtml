<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基于彩云天气API更新的天气信息</title>
    <style>
        body {
            line-height: 1;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f5ff;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .weather-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        .weather-card h2 {
            color: #3498db;
            margin-top: 0;
        }
        .weather-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 5px;
        }
        .weather-info p {
            margin: 10px 0;
        }
        .precipitation-info {
            list-style: none;
            padding: 0;
        }
        .precipitation-info li {
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        .precipitation-info li:last-child {
            border-bottom: none;
        }
        #temperatureChartContainer {
            height: 400px;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .weather-info {
                grid-template-columns: 1fr;
            }
            #temperatureChartContainer {
                height: 300px;
            }
        }
    </style>
	<ul class="precipitation-info">
</head>
<body>

    <div id="weatherInfo">正在加载天气数据...</div>
    <div class="weather-card" id="temperatureChartContainer">
        <h2>未来小时气温和湿度预报</h2>
        <canvas id="temperatureChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.0/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
        function fetchWeather() {
            const script = document.createElement('script');
            script.src = 'https://api.caiyunapp.com/v2.6/23333333/110.84,30.34/weather?dailysteps=5&hourlysteps=48&callback=displayWeather';
            document.body.appendChild(script);
        }

        function displayWeather(data) {
            const weatherInfo = document.getElementById('weatherInfo');
            let html = '';

            if (data && data.result && data.result.realtime) {
                const serverTime = data.server_time;
                const realtime = data.result.realtime;

                html += '<div class="weather-card">';
                html += '<h2>实时天气</h2>';
				const date = new Date(serverTime * 1000);
html += `<li><center><strong>获取时间: ${date.toLocaleString()}</strong></center></li>`;
                html += '<div class="weather-info">';
                
                html += `<p><strong>温度:</strong> ${realtime.temperature.toFixed(2)}°C</p>`;
html += `<p><strong>体感温度:</strong> ${realtime.apparent_temperature.toFixed(2)}°C</p>`;
html += `<p><strong>湿度:</strong> ${(realtime.humidity * 100).toFixed(0)}%</p>`;
html += `<p><strong>舒适度:</strong> ${realtime.life_index.comfort.desc}</p>`;
html += `<p><strong>天气状况:</strong> ${getSkyconDescription(realtime.skycon)}</p>`;
html += `<p><strong>能见度:</strong> ${realtime.visibility.toFixed(1)}km</p>`;
html += `<p><strong>紫外线指数:</strong> ${realtime.life_index.ultraviolet.index} (${realtime.life_index.ultraviolet.desc})</p>`;
html += `<p><strong>总云量:</strong> ${(realtime.cloudrate * 100).toFixed(0)}%</p>`;
html += `<p><strong>风速:</strong> ${realtime.wind.speed.toFixed(2)}km/h</p>`;
html += `<p><strong>风向:</strong> ${getWindDirection(realtime.wind.direction)}</p>`;
html += `<p><strong>气压:</strong> ${(realtime.pressure / 100).toFixed(2)} hPa</p>`;
html += `<p><strong>AQI:</strong> ${realtime.air_quality.aqi.chn} (${realtime.air_quality.description.chn})</p>`;
html += `<p><strong>PM2.5:</strong> ${realtime.air_quality.pm25} μg/m³</p>`;
html += `<p><strong>PM10:</strong> ${realtime.air_quality.pm10} μg/m³</p>`;
html += `<p><strong>臭氧浓度:</strong> ${realtime.air_quality.o3} μg/m³</p>`;
html += `<p><strong>一氧化碳浓度:</strong> ${realtime.air_quality.co} mg/m³</p>`;
html += `<p><strong>二氧化氮浓度:</strong> ${realtime.air_quality.no2} μg/m³</p>`;
html += `<p><strong>二氧化硫浓度:</strong> ${realtime.air_quality.so2} μg/m³</p>`;
html += `<p><strong>最近降水带距离:</strong> ${realtime.precipitation.nearest.distance.toFixed(2)} km</p>`;
html += `<p><strong>最近降水强度:</strong> ${realtime.precipitation.nearest.intensity.toFixed(2)} mm/h</p>`;
html += `<p><strong>本地降水强度:</strong> ${realtime.precipitation.local.intensity.toFixed(2)} mm/h</p>`;



                html += '</div></div>';

                // 小时级降水预报
html += '<div class="weather-card">';
html += '<h2>小时级降水预报</h2>';
html += '<ul class="precipitation-info">';
const hourly = data.result.hourly;
if (hourly && hourly.precipitation) {
    let hasPrecipitation = false;
    hourly.precipitation.forEach((precipitation) => {
        if (precipitation.value > 0) {
            hasPrecipitation = true;
            const datetime = new Date(precipitation.datetime);
            const month = datetime.getMonth() + 1; // 月份从0开始，所以要加1
            const day = datetime.getDate();
            const hour = datetime.getHours();
            const formattedDate = `${month}月${day}日${hour}点`;
            html += `<li><strong>${formattedDate}:</strong> 降水量 ${precipitation.value.toFixed(2)} mm / 降水概率 ${precipitation.probability}%</li>`;
        }
    });
    if (!hasPrecipitation) {
        html += '<li>未来48小时内无降水</li>';
    }
} else {
    html += '<li>暂无数据</li>';
}
html += '</ul></div>';


                // 未来3天预报
                html += '<div class="weather-card">';
                html += '<h2>未来3天预报</h2>';
                const daily = data.result.daily;

                if (daily && daily.temperature && daily.skycon && daily.air_quality && daily.wind) {
                    daily.temperature.slice(0, 3).forEach((temp, index) => {
                        if (daily.skycon[index] && daily.air_quality.aqi[index] && daily.wind[index]) {
                            const date = new Date(temp.date);
                            const formattedDate = `${date.getMonth() + 1}月${date.getDate()}日`;
                            
                            const skycon = getSkyconDescription(daily.skycon[index].value);
                            const aqi = daily.air_quality.aqi[index].avg ? daily.air_quality.aqi[index].avg.chn : '无数据';
                            const windSpeed = daily.wind[index].avg ? daily.wind[index].avg.speed.toFixed(1) : '无数据';
                            const windDirection = daily.wind[index].avg ? getWindDirection(daily.wind[index].avg.direction) : '无数据';

                            html += `<li><strong>${formattedDate}</strong>: ${temp.min.toFixed(1)}°C ~ ${temp.max.toFixed(1)}°C, ${skycon}, AQI: ${aqi}, 风速: ${windSpeed} km/h ${windDirection}</li>`;
                        }
                    });
                } else {
                    html += '<p>未来天气数据获取失败</p>';
                }

                html += '</div>';

                // 生成气温和湿度折线图
                const temperatureData = data.result.hourly.temperature;
                const humidityData = data.result.hourly.humidity;

                const labels = temperatureData.map(temp => {
                    const date = new Date(temp.datetime);
                    return `${date.getDate()}日${date.getHours()}点`;
                });

                const temperatureValues = temperatureData.map(temp => temp.value);
                const humidityValues = humidityData.map(hum => hum.value * 100);

                const ctx = document.getElementById('temperatureChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '气温 (°C)',
                                data: temperatureValues,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderWidth: 2,
                                yAxisID: 'y1',
                                tension: 0.1
                            },
                            {
                                label: '湿度 (%)',
                                data: humidityValues,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderWidth: 2,
                                yAxisID: 'y2',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '气温 (°C)'
                                }
                            },
                            y2: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '湿度 (%)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            } else {
                html = '<p>获取天气数据失败，请稍后再试。</p>';
            }

            weatherInfo.innerHTML = html;
        }

        function getSkyconDescription(skycon) {
            const skyconMap = {
                'CLEAR_DAY': '晴天',
                'CLEAR_NIGHT': '晴夜',
                'PARTLY_CLOUDY_DAY': '多云',
                'PARTLY_CLOUDY_NIGHT': '多云',
                'CLOUDY': '阴',
                'LIGHT_RAIN': '小雨',
                'MODERATE_RAIN': '中雨',
                'HEAVY_RAIN': '大雨',
                'STORM_RAIN': '暴雨',
                'FOG': '雾',
                'LIGHT_SNOW': '小雪',
                'MODERATE_SNOW': '中雪',
                'HEAVY_SNOW': '大雪',
                'STORM_SNOW': '暴雪',
                'DUST': '浮尘',
                'SAND': '沙尘',
                'WIND': '大风',
                'LIGHT_HAZE': '轻度雾霾',
                'MODERATE_HAZE': '中度雾霾',
                'HEAVY_HAZE': '重度雾霾'
            };
            return skyconMap[skycon] || skycon;
        }

        function getWindDirection(degree) {
            const directions = ['北', '东北', '东', '东南', '南', '西南', '西', '西北'];
            return directions[Math.round(degree / 45) % 8];
        }

        // 页面加载完成后获取天气信息
        window.onload = fetchWeather;
    </script>
</body>
</html>
